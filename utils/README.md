# Модули утилит для системы перевода

Этот каталог содержит вспомогательные модули, используемые основной системой перевода.

## Структура модулей

### `__init__.py`
Инициализационный файл, который экспортирует основные функции и классы из всех модулей для удобного импорта.

### `logger.py`
Модуль для логирования, предоставляющий следующие функции:
- `setup_logging` - настройка системы логирования с опциональным выводом в файл
- `log_info` - вывод информационных сообщений
- `log_error` - вывод сообщений об ошибках
- `log_debug` - вывод отладочных сообщений (только при уровне DEBUG)
- `log_warning` - вывод предупреждений

### `config.py`
Модуль для работы с конфигурацией:
- `load_config` - загрузка конфигурации из файла YAML
- `get_language_config` - получение конфигурации для указанного языка
- `get_system_prompt` - получение системного промпта для перевода
- `get_validation_prompt` - получение промпта для валидации
- `load_glossary` - загрузка глоссария терминов

### `file_utils.py`
Модуль для работы с файлами и их содержимым:
- `is_binary_file` - проверка является ли файл бинарным
- `extract_frontmatter` - извлечение фронтматтера из markdown-файла
- `restore_frontmatter` - восстановление фронтматтера в переведенном файле
- `split_content` - интеллектуальное разбиение контента на части с учетом маркдаун-структуры

### `prompt_utils.py`
Модуль для работы с промптами и их улучшениями:
- `load_prompt_improvements` - загрузка улучшений промптов из JSON-файла
- `save_prompt_improvement` - сохранение нового улучшения промпта
- `translate_frontmatter` - специализированный перевод фронтматтера

### `translator.py`
Модуль с основным классом для перевода:
- `Translator` - класс для перевода текста с использованием OpenAI API
  - `translate_text` - метод для перевода текста с сохранением контекста
  - `get_total_tokens` - получение общего количества использованных токенов

## Использование

Существует два основных сценария использования:

1.  **`main.py`**: Полный перевод всех файлов из `input_dir` в `output_dir`.
2.  **`main_target.py`**: Инкрементальный перевод только измененных файлов в указанном Git репозитории.

### 1. Полный перевод (`main.py`)

Этот скрипт подходит для первоначального перевода всей директории или когда не используется Git.

```bash
python main.py --language <код_языка> --input_dir <входная_папка> --output_dir <выходная_папка>
```

**Основные аргументы:**

*   `--language`: Целевой язык (`en`, `es`, `zh`) или `all` для всех языков.
*   `--input_dir`: Директория с исходными файлами (по умолчанию `input`).
*   `--output_dir`: Директория для сохранения результатов (по умолчанию `output`).
*   `--log_level`: Уровень логирования (`DEBUG`, `INFO`, `WARNING`, `ERROR`).
*   `--log_file`: Файл для сохранения логов.
*   `--max_workers`: Количество параллельных потоков (переопределяет значение из `config.yml`).
*   `--max_tokens`: Макс. токенов для чанка (переопределяет значение из `config.yml`).

### 2. Инкрементальный перевод измененных файлов в Git (`main_target.py`)

Этот скрипт предназначен для работы с документацией, находящейся в Git репозитории (например, проект Docusaurus). Он определяет, какие файлы были изменены или добавлены в директории с исходным языком (предполагается русский - `i18n/ru/...`) с момента последнего коммита, и переводит/копирует **только их** в соответствующие директории целевых языков.

**Предварительная настройка:**

1.  Убедитесь, что у вас установлен `git` и он доступен в системном `PATH`.
2.  В файле `.env` (созданном из `.env.example`) укажите **абсолютный путь** к **корневой папке** вашего локального Git репозитория в переменной `BOOK_PATH`.
    ```dotenv
    # .env
    # ... другие переменные ...
    BOOK_PATH=C:/path/to/your/book/repository 
    ```

**Запуск:**

```bash
python main_target.py --language <код_языка>
```

**Основные аргументы:**

*   `--language`: Целевой язык (`en`, `es`, `zh`) или `all` для перевода на все поддерживаемые языки.
*   `--log_level`: Уровень логирования (`DEBUG`, `INFO`, `WARNING`, `ERROR`).
*   `--log_file`: Файл для сохранения логов.
*   `--max_workers`: Количество параллельных потоков (переопределяет значение из `config.yml`).
*   `--max_tokens`: Макс. токенов для чанка (переопределяет значение из `config.yml`).

**Как это работает:**

1.  Скрипт использует `git status` внутри папки, указанной в `BOOK_PATH`, чтобы найти измененные и новые файлы в предопределенной директории русского языка (`i18n/ru/docusaurus-plugin-content-docs/current`).
2.  Для каждого найденного файла:
    *   Если это `.md` или `.mdx`, он переводится на указанный `--language` (или на все, если `all`).
    *   Если это файл другого типа, он просто копируется.
3.  Результат (переведенный или скопированный файл) сохраняется в соответствующей языковой директории (`docs` для `en`, `i18n/es/...` для `es`, `i18n/zh/...` для `zh`) внутри репозитория `BOOK_PATH`, сохраняя исходную структуру папок.

```python
# Импорт всех утилит
from utils import (
    log_info, setup_logging,
    load_config, load_glossary,
    is_binary_file, split_content,
    Translator
)

# Или импорт отдельных модулей
from utils.logger import log_info, setup_logging
from utils.config import load_config
from utils.file_utils import split_content
from utils.translator import Translator
``` 